<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÓPTICA LA FINA — ADMIN</title>
  <link rel="icon" href="/logo.png" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{--bg:#0e0e0f;--gold:#d4a017;--gold-bright:#f2c94c;--text:#f3f3f3;--muted:#a8adb3;--card:#141417}
    *{box-sizing:border-box}
    body{margin:0;font-family:Poppins,sans-serif;background:var(--bg);color:var(--text)}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:2px solid var(--gold)}
    .logo{display:flex;align-items:center;gap:10px}
    .logo img{width:30px;height:30px;border-radius:50%}
    .link{border:1px solid var(--gold);color:var(--gold);padding:6px 12px;border-radius:999px;text-decoration:none;font-weight:600}
    .link:hover{background:var(--gold);color:#111}
    h1{color:var(--gold-bright);text-align:center;margin:26px 0 6px}
    .panel{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid #2b2b2d;border-radius:16px;padding:18px;box-shadow:0 6px 14px rgba(0,0,0,.35)}
    .row{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr;gap:10px}
    input,select{padding:10px;border-radius:10px;border:1px solid #333;background:#1a1a1d;color:var(--text);width:100%}
    .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .btn.gold{background:var(--gold);color:#111}
    .btn.out{background:none;border:1px solid var(--gold);color:var(--gold)}
    .msg{margin-top:10px;color:#6ee7a8}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px;margin-top:18px}
    .item{background:#151517;border:1px solid #2b2b2d;border-radius:14px;overflow:hidden}
    .item img{width:100%;height:160px;object-fit:cover}
    .item .info{padding:10px}
    .danger{background:#361b1b;border:1px solid #a33;color:#f8bbbb}
    footer{text-align:center;border-top:2px solid var(--gold);margin-top:24px;padding:12px;color:#bbb}
    .loginBox{max-width:560px;margin:40px auto}
    .center{display:flex;gap:8px;justify-content:center;align-items:center}
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="/logo.png" alt="logo" />
      <b>ÓPTICA LA FINA — ADMIN</b>
    </div>
    <a href="/" class="link">Volver al catálogo</a>
  </header>

  <h1>Acceso administrador</h1>

  <div class="panel">
    <!-- Login -->
    <div id="login" class="loginBox card">
      <div class="center" style="margin-bottom:10px">
        <input id="adminPass" type="password" placeholder="Contraseña admin" autocomplete="current-password" />
        <button id="btnLogin" class="btn gold">Entrar</button>
      </div>
      <small style="color:var(--muted);display:block;text-align:center">Se guarda en una sesión segura.</small>
      <div id="loginMsg" class="msg" style="display:none"></div>
    </div>

    <!-- Panel admin -->
    <div id="adminPanel" class="card" style="display:none">
      <div class="row">
        <input id="pName" placeholder="Nombre" />
        <input id="pStock" type="number" placeholder="Stock" />
        <input id="pPrice" type="number" placeholder="Precio" />
        <input id="pCode" placeholder="Código (opcional)" />
        <select id="pCategory">
          <option value="recetado">Recetado</option>
          <option value="sol">Sol</option>
          <option value="hombre">Hombre</option>
          <option value="mujer">Mujer</option>
          <option value="niños">Niños</option>
          <option value="metal">Metal</option>
          <option value="acetato">Acetato</option>
          <option value="titanio">Titanio</option>
        </select>
      </div>
      <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
        <input id="pImage" placeholder="URL de imagen (opcional)" style="flex:1" />
        <input id="pickFile" type="file" accept="image/*" style="display:none" />
        <button id="btnPick" class="btn out">Subir imagen</button>
        <button id="btnAdd" class="btn gold">Agregar</button>
        <button id="btnLogout" class="btn out">Cerrar sesión</button>
      </div>
      <small id="uploadMsg" class="msg" style="display:none"></small>

      <div id="list" class="grid"></div>
    </div>
  </div>

  <footer>© Óptica La Fina — Santaní PY</footer>

  <script>
    const $ = (sel) => document.querySelector(sel);

    // Estado de sesión al cargar
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        const r = await fetch("/api/me", { credentials: "include" });
        const d = await r.json();
        showAdmin(!!d.ok);
      } catch {
        showAdmin(false);
      }
      renderList(); // por si ya hay productos
    });

    function showAdmin(on){
      $("#login").style.display = on ? "none" : "block";
      $("#adminPanel").style.display = on ? "block" : "none";
    }

    // Login
    $("#btnLogin").onclick = async () => {
      $("#loginMsg").style.display = "none";
      const pw = $("#adminPass").value.trim();
      const r = await fetch("/api/auth/admin", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        credentials: "include",
        body: JSON.stringify({ password: pw })
      });
      if (!r.ok) {
        $("#loginMsg").textContent = "Contraseña incorrecta.";
        $("#loginMsg").style.display = "block";
        return;
      }
      showAdmin(true);
    };

    // Logout
    $("#btnLogout").onclick = async () => {
      await fetch("/api/logout", { method: "POST", credentials: "include" });
      showAdmin(false);
    };

    // Subir imagen
    $("#btnPick").onclick = () => $("#pickFile").click();
    $("#pickFile").onchange = async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const fd = new FormData();
      fd.append("image", file);
      const up = await fetch("/api/upload", { method:"POST", body: fd, credentials:"include" });
      const data = await up.json();
      if (!up.ok || !data.ok) { alert("No se pudo subir"); return; }
      $("#pImage").value = data.url;
      $("#uploadMsg").textContent = "Imagen subida ✓";
      $("#uploadMsg").style.display = "block";
      setTimeout(() => ($("#uploadMsg").style.display = "none"), 2000);
    };

    // Agregar producto
    $("#btnAdd").onclick = async () => {
      const payload = {
        name: $("#pName").value.trim(),
        stock: Number($("#pStock").value||0),
        price: Number($("#pPrice").value||0),
        code: $("#pCode").value.trim(),
        category: $("#pCategory").value,
        image: $("#pImage").value.trim()
      };
      if (!payload.name) return alert("Nombre requerido");
      const r = await fetch("/api/products", {
        method:"POST",
        credentials:"include",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const d = await r.json();
      if (!r.ok) return alert("No se pudo agregar");
      clearForm();
      renderList();
    };

    function clearForm(){
      ["#pName","#pStock","#pPrice","#pCode","#pImage"].forEach(s=>$(s).value="");
      $("#pCategory").value = "recetado";
    }

    // Listado con eliminar
    async function renderList(){
      const box = $("#list");
      const r = await fetch("/api/products");
      const rows = await r.json();
      box.innerHTML = rows.map(p => `
        <div class="item">
          <img src="${p.image||"/logo.png"}" onerror="this.src='/logo.png'"/>
          <div class="info">
            <b>${p.name}</b><br>
            <small>Gs ${Number(p.price||0).toLocaleString()} · Stock: ${p.stock||0}</small><br>
            <small>Código: ${p.code||"-"} · ${p.category||"-"}</small>
            <div style="margin-top:8px">
              <button class="btn danger" onclick="delProd('${p.id}')">Eliminar</button>
            </div>
          </div>
        </div>
      `).join("");
    }

    window.delProd = async (id) => {
      if (!confirm("¿Eliminar este producto?")) return;
      const r = await fetch(`/api/products/${id}`, { method:"DELETE", credentials:"include" });
      if (!r.ok) return alert("No se pudo eliminar");
      renderList();
    };
  </script>
</body>
</html>
