<!-- public/stock.html -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ÓPTICA LA FINA — ADMIN</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    .admin-card{max-width:860px;margin:40px auto;padding:24px;border:1px solid #6b560a;border-radius:14px;background:#111;}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .row input,.row select{background:#0e0e0e;border:1px solid #444;color:#eee;padding:10px;border-radius:10px}
    .btn{background:#d4aa2a;border:none;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .topbar{display:flex;justify-content:flex-end;padding:8px 14px}
    .muted{color:#9aa0a6;font-size:.9rem;margin-top:6px}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{border-bottom:1px solid #333;padding:10px;text-align:left}
    .danger{background:#8a1f1f}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="brand"><img src="/logo.png" alt="" class="logo-sm"> <span>ÓPTICA LA FINA — ADMIN</span></div>
    <div class="topbar">
      <a href="/" class="btn" style="background:#222;border:1px solid #d4aa2a">Volver al catálogo</a>
    </div>
  </header>

  <main class="container">
    <section class="admin-card">
      <h2>Acceso administrador</h2>
      <div id="loginBox" class="row" style="align-items:center">
        <input id="adminPass" type="password" placeholder="Contraseña admin" style="flex:1;max-width:420px">
        <button id="btnLogin" class="btn">Entrar</button>
        <span id="loginMsg" class="muted"></span>
      </div>

      <div id="adminArea" style="display:none">
        <h3 style="margin-top:18px">Agregar producto</h3>
        <div class="row">
          <input id="pName" placeholder="Nombre" style="flex:2">
          <input id="pStock" type="number" min="0" placeholder="Stock" style="width:120px">
          <input id="pPrice" type="number" min="0" placeholder="Precio" style="width:160px">
          <input id="pCode" placeholder="Código (opcional)" style="width:180px">
          <select id="pCategory">
            <option>Recetado</option><option>Hombre</option><option>Mujer</option>
            <option>Niños</option><option>Sol</option><option>Metal</option>
            <option>Acetato</option><option>Titanio</option>
          </select>
        </div>
        <div class="row" style="align-items:center">
          <input id="pImage" placeholder="URL de imagen (opcional)" style="flex:1">
          <input id="pickFile" type="file" accept="image/*" style="display:none">
          <button id="btnPick" class="btn">Subir imagen</button>
          <button id="btnAdd" class="btn">Agregar</button>
          <button id="btnLogout" class="btn" style="background:#222;border:1px solid #d4aa2a">Cerrar sesión</button>
        </div>
        <div id="upMsg" class="muted"></div>

        <h3 style="margin-top:28px">Lista actual</h3>
        <div style="overflow:auto">
          <table id="tbl">
            <thead>
              <tr>
                <th>Imagen</th><th>Nombre</th><th>Código</th><th>Categoría</th>
                <th>Precio</th><th>Stock</th><th>Acciones</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">© Óptica La Fina — Santaní PY</footer>

  <script>
    const $ = (s)=>document.querySelector(s);

    async function showAdmin(logged){
      $("#loginBox").style.display = logged? "none":"flex";
      $("#adminArea").style.display = logged? "block":"none";
      if(logged) loadList();
    }

    // al cargar, verificar sesión
    window.addEventListener("DOMContentLoaded", async ()=>{
      try{
        const r = await fetch("/api/me",{credentials:"include"});
        const j = await r.json();
        showAdmin(j.admin);
      }catch{ showAdmin(false); }
    });

    // login
    $("#btnLogin").onclick = async ()=>{
      $("#loginMsg").textContent = "";
      const pw = $("#adminPass").value.trim();
      const r = await fetch("/api/auth/admin",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        credentials:"include",
        body: JSON.stringify({password: pw})
      });
      if(r.ok){ showAdmin(true); }
      else { $("#loginMsg").textContent = "Contraseña incorrecta"; }
    };

    // logout
    $("#btnLogout").onclick = async ()=>{
      await fetch("/api/logout",{method:"POST",credentials:"include"});
      location.reload();
    };

    // subir imagen
    $("#btnPick").onclick = ()=> $("#pickFile").click();
    $("#pickFile").onchange = async (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const fd = new FormData();
      fd.append("image", f);
      $("#upMsg").textContent = "Subiendo...";
      const r = await fetch("/api/upload",{method:"POST",credentials:"include",body:fd});
      const j = await r.json();
      if(r.ok && j.url){
        $("#pImage").value = j.url;
        $("#upMsg").textContent = "Imagen subida ✓";
      }else{
        $("#upMsg").textContent = "No se pudo subir";
      }
    };

    // agregar
    $("#btnAdd").onclick = async ()=>{
      const payload = {
        name: $("#pName").value.trim(),
        stock: $("#pStock").value,
        price: $("#pPrice").value,
        code: $("#pCode").value.trim(),
        category: $("#pCategory").value,
        image: $("#pImage").value.trim()
      };
      if(!payload.name){ alert("Nombre requerido"); return; }
      const r = await fetch("/api/products",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        credentials:"include",
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if(r.ok){ limpiar(); loadList(); }
      else alert("No se pudo agregar");
    };

    function limpiar(){
      ["#pName","#pStock","#pPrice","#pCode","#pImage"].forEach(s=>$(s).value="");
      $("#pCategory").value = "Recetado";
      $("#upMsg").textContent = "";
    }

    async function loadList(){
      const r = await fetch("/api/products",{credentials:"include"});
      const {items=[]} = await r.json();
      const tb = $("#rows");
      tb.innerHTML = "";
      for(const p of items){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.image? `<img src="${p.image}" style="width:52px;height:52px;object-fit:cover;border-radius:8px">`:"—"}</td>
          <td>${escapeHtml(p.name||"")}</td>
          <td>${escapeHtml(p.code||"")}</td>
          <td>${cap(p.category||"")}</td>
          <td>Gs ${Number(p.price||0).toLocaleString("es-PY")}</td>
          <td>${p.stock||0}</td>
          <td><button class="btn danger" data-id="${p.id}">Eliminar</button></td>`;
        tb.appendChild(tr);
      }
      // bind eliminar
      tb.querySelectorAll("button[data-id]").forEach(btn=>{
        btn.onclick = async ()=>{
          if(!confirm("¿Eliminar este producto?")) return;
          const id = btn.dataset.id;
          const r = await fetch(`/api/products/${id}`,{
            method:"DELETE",
            credentials:"include"
          });
          if(r.ok) loadList();
          else alert("No se pudo eliminar");
        };
      });
    }

    function cap(s){ return (s||"").charAt(0).toUpperCase()+ (s||"").slice(1); }
    function escapeHtml(x){ return (x||"").replace(/[&<>"]/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m])); }
  </script>
</body>
</html>
