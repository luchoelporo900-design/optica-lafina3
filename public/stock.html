<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin — Óptica La Fina</title>
<link rel="icon" type="image/png" href="/logo.png" />
<link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header class="header">
    <div class="brand">
      <img src="/logo.png" alt="Óptica La Fina" />
      <span>ÓPTICA LA FINA — ADMIN</span>
    </div>
    <a class="admin" href="/index.html">Volver al catálogo</a>
  </header>

  <div class="admin-wrap">
    <div class="admin-title"><img src="/logo.png" alt=""> <h2 style="margin:0">Acceso administrador</h2></div>
    <div id="loginBox" class="row">
      <input id="adminPass" type="password" placeholder="Contraseña admin" />
      <button id="btnLogin">Entrar</button>
      <div class="note">Se guarda en una sesión segura.</div>
    </div>

    <div id="panel" style="display:none">
      <h3 class="admin-title" style="margin-top:6px"><img src="/logo.png" alt="">Agregar producto</h3>
      <div class="row">
        <input id="pName" placeholder="Nombre" />
        <input id="pStock" type="number" min="0" placeholder="Stock" />
        <input id="pPrice" type="number" min="0" placeholder="Precio" />
        <input id="pCode" placeholder="Código (opcional)" />
        <select id="pCategory">
          <option>Recetado</option><option>Hombre</option><option>Mujer</option>
          <option>Niños</option><option>Sol</option><option>Metal</option>
          <option>Acetato</option><option>Titanio</option>
        </select>
      </div>

      <div class="row">
        <input id="pImage" placeholder="URL de imagen (opcional)" style="flex:1" />
        <input id="pickFile" type="file" accept="image/*" style="display:none" />
        <button id="btnUpload" type="button">Subir imagen</button>
        <button id="btnAdd" type="button">Agregar</button>
        <button id="btnLogout" type="button" style="margin-left:auto;background:#222;color:#fff;border-color:#333">Cerrar sesión</button>
      </div>

      <div id="preview" class="preview"><img alt="Vista previa"></div>
      <div class="note">Si subes una imagen, se completa el campo automáticamente.</div>
    </div>
  </div>

<script>
const $=s=>document.querySelector(s);
const api=(p,opt={})=>fetch(p,{credentials:'include',...opt});

/* Estado de sesión al entrar */
(async()=>{
  try{
    const r=await api('/api/me'); const d=await r.json();
    if(d && d.ok){ showPanel(true); } else { showPanel(false); }
  }catch{ showPanel(false); }
})();

function showPanel(on){
  $('#loginBox').style.display = on?'none':'';
  $('#panel').style.display = on?'':'none';
}

/* Login */
$('#btnLogin').onclick=async()=>{
  try{
    const pw = $('#adminPass').value.trim();
    const r = await api('/api/auth/admin',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pw})});
    const d = await r.json();
    if(d && d.ok){ showPanel(true); } else { alert('Contraseña incorrecta'); }
  }catch{ alert('No se pudo iniciar sesión'); }
};

/* Logout */
$('#btnLogout').onclick=async()=>{
  await api('/api/logout',{method:'POST'});
  showPanel(false);
};

/* Upload imagen */
$('#btnUpload').onclick=()=>$('#pickFile').click();
$('#pickFile').onchange=async(e)=>{
  const file = e.target.files[0]; if(!file) return;
  try{
    const fd = new FormData(); fd.append('image',file);
    const r = await api('/api/upload',{method:'POST',body:fd});
    const d = await r.json();
    if(d && d.path){
      $('#pImage').value = d.path; // ej: /uploads/xxx.png
      const pv = $('#preview'); pv.style.display='block'; pv.querySelector('img').src = d.path.startsWith('http')? d.path : d.path;
      alert('Imagen subida ✓');
    }else{ alert('No se pudo subir'); }
  }catch{ alert('Error al subir'); }
};

/* Agregar producto */
$('#btnAdd').onclick=async()=>{
  const payload = {
    name: $('#pName').value.trim(),
    stock: Number($('#pStock').value||0),
    price: Number($('#pPrice').value||0),
    code: $('#pCode').value.trim(),
    category: $('#pCategory').value,
    image: $('#pImage').value.trim()
  };
  if(!payload.name){ alert('Nombre requerido'); return; }
  try{
    const r = await api('/api/products',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const d = await r.json();
    if(d && d.ok){ alert('Producto agregado ✓'); clearForm(); }
    else{ alert('No autorizado o error al guardar'); }
  }catch{ alert('Error de red'); }
};
function clearForm(){
  ['#pName','#pStock','#pPrice','#pCode','#pImage'].forEach(s=>$(s).value='');
  $('#preview').style.display='none';
}
</script>
</body>
</html>
