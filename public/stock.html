<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Óptica La Fina — ADMIN</title>
  <link rel="icon" type="image/png" href="logo.png"/>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
<header class="topbar">
  <div class="brand"><img src="logo.png"><span>ÓPTICA LA FINA — ADMIN</span></div>
  <nav><a class="admin-link" href="/" style="margin-right:8px">Catálogo</a>
       <button id="btnLogout" class="admin-link" style="border-color:#c0392b">Cerrar sesión</button></nav>
</header>

<main class="container">
  <section id="loginBox" class="panel">
    <h2>Acceso administrador</h2>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="adminPass" type="password" placeholder="Contraseña admin" />
      <button id="btnLogin" class="admin-link">Entrar</button>
    </div>
    <p class="muted">Se guarda en una sesión segura.</p>
    <p id="loginMsg" class="status" style="color:#f88"></p>
  </section>

  <section id="adminBox" class="panel" style="display:none">
    <h2>Agregar producto</h2>
    <div class="formrow">
      <input id="pName" placeholder="Nombre"/>
      <input id="pStock" type="number" placeholder="Stock"/>
      <input id="pPrice" type="number" placeholder="Precio"/>
      <input id="pCode" placeholder="Código (opcional)"/>
      <select id="pCategory">
        <option>Recetado</option><option>Sol</option>
        <option>Hombre</option><option>Mujer</option><option>Niños</option>
        <option>Metal</option><option>Acetato</option><option>Titanio</option>
      </select>
    </div>

    <div class="formrow">
      <input id="pImage" placeholder="URL de imagen (opcional)" />
      <input id="pickFile" type="file" accept="image/*" style="display:none"/>
      <button id="btnPick" class="admin-link">Subir imagen</button>
      <img id="preview" style="display:none;height:80px;border-radius:8px;margin-left:8px"/>
    </div>

    <div class="formrow">
      <button id="btnAdd" class="admin-link">Agregar</button>
      <span id="addMsg" class="status"></span>
    </div>
  </section>
</main>

<script>
const $=s=>document.querySelector(s);
const loginBox=$("#loginBox"), adminBox=$("#adminBox");
const msg=$("#loginMsg"), addMsg=$("#addMsg");
const btnLogin=$("#btnLogin"), btnLogout=$("#btnLogout");
const adminPass=$("#adminPass");
const pName=$("#pName"), pStock=$("#pStock"), pPrice=$("#pPrice"), pCode=$("#pCode"), pCategory=$("#pCategory");
const pImage=$("#pImage"), pickFile=$("#pickFile"), btnPick=$("#btnPick"), preview=$("#preview");

// al cargar, recuperar sesión
window.addEventListener("DOMContentLoaded", async ()=>{
  try{
    const r=await fetch("/api/me"); const d=await r.json();
    showAdmin(!!d.admin);
  }catch{ showAdmin(false) }
});

function showAdmin(on){
  loginBox.style.display = on? "none":"block";
  adminBox.style.display = on? "block":"none";
}
// login
btnLogin.onclick = async ()=>{
  msg.textContent="";
  const pw = adminPass.value.trim();
  const r = await fetch("/api/auth/admin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:pw})});
  if(r.ok) showAdmin(true); else msg.textContent="Contraseña incorrecta";
};
// logout
btnLogout.onclick = async ()=>{ await fetch("/api/logout",{method:"POST"}); showAdmin(false); };

// subir imagen
btnPick.onclick = ()=> pickFile.click();
pickFile.onchange = async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const fd = new FormData(); fd.append("image", f);
  btnPick.textContent="Subiendo..."; btnPick.disabled=true;
  const r = await fetch("/api/upload",{method:"POST", body:fd});
  btnPick.textContent="Subir imagen"; btnPick.disabled=false;
  const d = await r.json();
  if(d.ok){ pImage.value = d.url; preview.src=d.url; preview.style.display="inline"; alert("Imagen subida ✔"); }
  else alert("No se pudo subir");
};

// agregar producto
$("#btnAdd").onclick = async ()=>{
  addMsg.textContent="";
  const payload = {
    name:pName.value.trim(), stock:Number(pStock.value||0), price:Number(pPrice.value||0),
    code:pCode.value.trim(), category:pCategory.value.trim(), image:pImage.value.trim()
  };
  if(!payload.name){ alert("Nombre requerido"); return; }
  const r = await fetch("/api/products",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  const d = await r.json();
  if(d.ok){
    ["#pName","#pStock","#pPrice","#pCode","#pImage"].forEach(s=>$(s).value="");
    preview.style.display="none";
    addMsg.textContent = "Producto agregado ✔";
  }else alert("No se pudo agregar");
};
</script>
</body>
</html>
