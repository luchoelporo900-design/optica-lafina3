<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ÓPTICA LA FINA</title>
<link rel="icon" href="/logo.png">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0e0e0f;--gold:#d4a017;--gold-bright:#f2c94c;--text:#f3f3f3;--muted:#9aa0a6;--card:#141417;}
*{box-sizing:border-box} body{margin:0;font-family:Poppins,sans-serif;background:var(--bg);color:var(--text);}
header{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;border-bottom:2px solid var(--gold);}
.logo{display:flex;align-items:center;gap:10px;} .logo img{width:30px;height:30px;border-radius:50%;}
h1{color:var(--gold-bright);text-align:center;margin:30px 0 10px;}
.search{text-align:center;margin-bottom:10px;}
input{padding:10px;border-radius:10px;border:1px solid #333;background:#1a1a1d;color:var(--text);width:260px;}
.filters{text-align:center;margin:15px 0;}
button.filter{background:none;border:1px solid var(--gold);color:var(--text);padding:6px 12px;margin:4px;border-radius:20px;cursor:pointer;}
button.filter.active{background:var(--gold);color:#000;font-weight:700;}
.catalog{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px;padding:20px;}
.card{background:var(--card);border:1px solid #2b2b2d;border-radius:16px;overflow:hidden;box-shadow:0 5px 12px rgba(0,0,0,.3);transition:transform .2s;}
.card:hover{transform:translateY(-4px);}
.card img{width:100%;height:180px;object-fit:cover;cursor:zoom-in;}
.card .info{padding:12px;}
.price{color:var(--gold-bright);font-weight:600;}
.btn{display:inline-block;margin-top:8px;padding:8px 12px;border-radius:10px;text-decoration:none;font-size:14px;}
.btn.whatsapp{background:var(--gold);color:#111;font-weight:600;}
.btn.fav{background:none;border:1px solid var(--gold);color:var(--gold);}
.btn.fav.active{background:var(--gold);color:#111;font-weight:700;}
.bottom-bar{position:fixed;bottom:0;left:0;width:100%;background:#111;border-top:2px solid var(--gold);padding:10px;text-align:center;}
footer{text-align:center;border-top:2px solid var(--gold);margin-top:30px;padding:10px;color:#bbb;}

/* Lightbox */
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,.88);display:none;align-items:center;justify-content:center;z-index:9999;}
.lightbox.open{display:flex;}
.lightbox img{max-width:92vw;max-height:88vh;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.6);}
.lightbox .close{position:absolute;top:18px;right:22px;background:#000;border:1px solid #555;color:#fff;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:700}
</style>
</head>
<body>
<header>
  <div class="logo">
    <img src="/logo.png" alt="logo">
    <b>ÓPTICA LA FINA</b>
  </div>
  <a href="/stock.html" class="btn fav">Subir productos (Admin)</a>
</header>

<h1>Catálogo de Lentes</h1>
<div class="search">
  <input id="buscar" placeholder="Buscar por nombre o código...">
</div>
<div class="filters" id="filtros">
  <button class="filter active" data-cat="todos">Todos</button>
  <button class="filter" data-cat="hombre">Hombre</button>
  <button class="filter" data-cat="mujer">Mujer</button>
  <button class="filter" data-cat="niños">Niños</button>
  <button class="filter" data-cat="sol">Sol</button>
  <button class="filter" data-cat="recetado">Recetado</button>
  <button class="filter" data-cat="metal">Metal</button>
  <button class="filter" data-cat="acetato">Acetato</button>
  <button class="filter" data-cat="titanio">Titanio</button>
  <button class="filter" data-cat="favoritos">Favoritos</button>
</div>

<div class="catalog" id="catalogo"></div>

<div class="bottom-bar">
  <button id="enviarWA" class="btn whatsapp">Enviar por WhatsApp (0)</button>
</div>

<footer>© Óptica La Fina — Santaní PY</footer>

<!-- LIGHTBOX -->
<div id="lightbox" class="lightbox" role="dialog" aria-label="Vista ampliada">
  <button class="close" id="lbClose">✕</button>
  <img id="lbImg" src="" alt="Vista ampliada">
</div>

<script>
const CATALOGO = document.getElementById('catalogo');
const NUM_WA = '595987459717'; // tu número
let productos = [];
let favoritos = JSON.parse(localStorage.getItem('favoritos')||'[]');
let filtro='todos';

// Lightbox helpers
const lb = document.getElementById('lightbox');
const lbImg = document.getElementById('lbImg');
const lbClose = document.getElementById('lbClose');
function abrirLightbox(src){
  lbImg.src = src || '/logo.png';
  lb.classList.add('open');
}
function cerrarLightbox(){
  lb.classList.remove('open');
  lbImg.src = '';
}
lb.addEventListener('click', (e)=>{ if(e.target===lb) cerrarLightbox(); });
lbClose.addEventListener('click', cerrarLightbox);
document.addEventListener('keydown', e=>{ if(e.key==='Escape') cerrarLightbox(); });

// Cargar productos
async function cargar(){
  const res = await fetch('/api/products');
  productos = await res.json();
  render();
}
cargar();

// Render
function render(){
  const term = document.getElementById('buscar').value.toLowerCase();
  let lista = productos.filter(p=> 
    (filtro==='todos'||p.category===filtro||(filtro==='favoritos'&&favoritos.includes(p.id))) &&
    (p.name.toLowerCase().includes(term)||p.code?.toLowerCase().includes(term))
  );
  CATALOGO.innerHTML = lista.map(p=>`
    <div class="card">
      <img src="${p.image||'/logo.png'}" alt="${p.name}" onerror="this.src='/logo.png'" onclick="abrirLightbox('${(p.image||'/logo.png').replace(/'/g, '%27')}')">
      <div class="info">
        <b>${p.name}</b><br>
        <span class="price">Gs ${Number(p.price||0).toLocaleString()}</span><br>
        <small>Código: ${p.code||'-'}</small><br>
        <small>Categoría: ${p.category||'-'}</small><br>
        <a href="https://wa.me/${NUM_WA}?text=Hola!%20Estoy%20interesado%20en%20${encodeURIComponent(p.name)}%20(${p.code||'-'})" target="_blank" class="btn whatsapp">WhatsApp</a>
        <button class="btn fav ${favoritos.includes(p.id)?'active':''}" onclick="toggleFav('${p.id}')">Favoritos</button>
      </div>
    </div>
  `).join('') || "<p style='text-align:center;color:#777'>No se encontraron productos.</p>";
  actualizarBotonWA();
}

// Buscar
document.getElementById('buscar').oninput=()=>render();

// Filtros
document.querySelectorAll('#filtros .filter').forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll('#filtros .filter').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    filtro=b.dataset.cat;
    render();
  }
});

// Favoritos
function toggleFav(id){
  if(favoritos.includes(id)) favoritos=favoritos.filter(f=>f!==id);
  else favoritos.push(id);
  localStorage.setItem('favoritos',JSON.stringify(favoritos));
  render();
}

// Enviar WhatsApp con favoritos
function actualizarBotonWA(){
  document.getElementById('enviarWA').innerText = `Enviar por WhatsApp (${favoritos.length})`;
}
document.getElementById('enviarWA').onclick=()=>{
  if(!favoritos.length){alert('No tienes favoritos seleccionados');return;}
  const sel = productos.filter(p=>favoritos.includes(p.id));
  const texto = sel.map(p=>`• ${p.name} - Gs ${p.price} (Cod: ${p.code||'-'})`).join('%0A');
  window.open(`https://wa.me/${NUM_WA}?text=Hola!%20Estos%20son%20mis%20favoritos:%0A${texto}`,'_blank');
};
</script>
</body>
</html>
